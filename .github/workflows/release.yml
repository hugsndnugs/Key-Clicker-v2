name: Build and Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '.gitignore'
      - 'LICENSE'

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Get and increment version
      id: version
      run: |
        # Get the latest version tag
        $latestTag = git describe --tags --match "v*.*" --abbrev=0 2>$null
        if ($LASTEXITCODE -ne 0) {
          # No tags found, start with v2.1
          $version = "2.1"
        } else {
          # Extract version number from tag (e.g., v2.1 -> 2.1)
          $versionMatch = $latestTag -match "v(\d+)\.(\d+)"
          if ($versionMatch) {
            $major = [int]$matches[1]
            $minor = [int]$matches[2]
            # Increment minor version
            $minor++
            $version = "$major.$minor"
          } else {
            # Fallback to v2.1 if tag format is unexpected
            $version = "2.1"
          }
        }
        
        $newTag = "v$version"
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "TAG=$newTag" >> $env:GITHUB_ENV
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$newTag" >> $env:GITHUB_OUTPUT
        echo "Current version: $version"
        echo "New tag: $newTag"
    
    - name: Update README version badge
      run: |
        # Update the version badge in README.md
        $readmePath = "README.md"
        $content = Get-Content $readmePath -Raw
        
        # Pattern to match the version badge and replace version number
        $newVersion = $env:VERSION
        $content = $content -replace '!\[Version\]\(https://img\.shields\.io/badge/version-[\d.]+-blue\.svg\)', "![Version](https://img.shields.io/badge/version-$newVersion-blue.svg)"
        
        # Write back to file
        Set-Content -Path $readmePath -Value $content -NoNewline
        Write-Host "Updated README.md version badge to $newVersion"
    
    - name: Commit README changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add README.md
        
        # Only commit if there are changes
        $status = git status --porcelain README.md
        if ($status) {
          git commit -m "chore: Update version badge to ${{ env.VERSION }}"
          git push
        } else {
          Write-Host "No changes to README.md, skipping commit"
        }
    
    - name: Build executable
      run: |
        python build.py ${{ env.VERSION }}
        Write-Host "Build completed, checking dist directory..."
        Get-ChildItem -Path dist -Recurse | ForEach-Object { Write-Host $_.FullName }
    
    - name: Find executable
      id: find-exe
      run: |
        $exePath = Get-ChildItem -Path dist -Filter "*.exe" -Recurse | Select-Object -First 1
        if ($exePath) {
          echo "executable=$($exePath.FullName)" >> $env:GITHUB_OUTPUT
          echo "executable-name=$($exePath.Name)" >> $env:GITHUB_OUTPUT
          echo "Found executable: $($exePath.FullName)"
        } else {
          Write-Error "Executable not found in dist directory"
          Get-ChildItem -Path dist -Recurse | ForEach-Object { Write-Host $_.FullName }
          exit 1
        }
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG }}
        name: Release ${{ env.TAG }}
        body: |
          ## Auto Key Clicker ${{ env.TAG }}
          
          Automated release built from commit ${{ github.sha }}
          
          ### Changes
          - See commit history for details
          
          ### Download
          Download the `AutoKeyClicker.exe` file from the assets below.
        files: dist/AutoKeyClicker.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

